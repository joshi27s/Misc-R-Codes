---
title: "581 HW1 Programming Questions"
author: "Austin Craig"
date: '2022-04-01'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mvtnorm)
library(car)
library(boot)
#options(digits=3)
```

<br>

### Create the sample:

```{r sample}
# sample 50 iid observations from y
n_obs = 50
mu = c(1,1)
sigma = cbind(c(0.25^2,0),c(0,1))
set.seed(123)

# create a matrix for the sample using the multivariate normal distribution
y = rmvnorm(n_obs,mu,sigma)

# calculate sample means and covariance matrix
mu_hat = colMeans(y)
sigma_hat = cov(y)

```

### Sample means and covariance matrix:

```{r muhat, sigmahat tables, echo=FALSE}
knitr::kable(mu_hat,col.names="mu hat",caption="Sample Means")
knitr::kable(sigma_hat,caption="Sample Covariance Matrix")
```
<br>


### Question 1: Monte Carlo

```{r monte carlo}

N = 10000

#init a vector to store the estimators
theta_hats = rep(0,N)

#Monte Carlo
for (i in 1:N) {
  sim_y = rmvnorm(n_obs,mu,sigma)
  sim_mu_hat = colMeans(sim_y)
  theta_hats[i] = sim_mu_hat[1] / sim_mu_hat[2]
}

#calculate the standard error of theta:
se_theta_mc = sd(theta_hats)

#95% CI of theta:
ci_low = mean(theta_hats) - 1.96*se_theta_mc
ci_high = mean(theta_hats) + 1.96*se_theta_mc
```

So the numerically computed standard error for $\hat{\theta}$ is `r se_theta_mc` and the 95% confidence interval for $\theta$ is [`r ci_low`,`r ci_high`].

<br>

### Question 2: Delta Method

We are interested in the asymptotic standard error of $\hat{\theta}$, $\sqrt{\hat{V}_{\hat{\theta}}}$. We know that $\theta=\frac{\mu_1}{\mu_2}$ and that $\sqrt{n}(\hat{\mu}-\mu)$ is asymptotically normally distributed with variance $V_\mu=\Sigma=diag((0.25)^2,1)$. Furthermore, $\hat{V}_{\mu}=\hat{\Sigma}=n\hat{V}_{\hat{\mu}}$, so $\hat{V}_{\hat{\mu}}=\frac{1}{n}\hat{\Sigma}$.



Since $\hat{\theta}$ is a function of $\hat{\mu}$, we can apply the delta method to show that $\sqrt{n}(\hat{\theta}-\theta)$ converges in distribution to $\hat{V}_{\hat{\theta}}=\hat{R}'\hat{V}_{\hat{\mu}} \hat{R}$, where $\hat{R}=\frac{\partial \hat{\theta}}{\partial \hat{\mu}}=(\frac{1}{\hat{\mu_2}}, -\frac{\hat{\mu_1}}{\hat{\mu_2^2}})'$.

```{r delta method by hand}
V_hat_mu_hat = (1/n_obs)*sigma_hat
R_hat = c(1/mu_hat[2], -mu_hat[1]/(mu_hat[2])^2)
V_hat_theta_hat = R_hat%*%V_hat_mu_hat%*%R_hat
sehat_thetahat = as.numeric(sqrt(V_hat_theta_hat))
sehat_thetahat

```



```{r numerical delta method}
#theta_hat = mu_hat[1] / mu_hat[2]
f_string = "muhat1/muhat2"
names(mu_hat) = c("muhat1", "muhat2")
rownames(sigma_hat) = colnames(sigma_hat) = names(mu_hat)
dm = deltaMethod(mu_hat, f_string, (1/n_obs)*sigma_hat)
dm
```
Notice that the analytic and the numerical delta method approaches both produce a standard error of approximately 0.131.

<br>

### Question 3: Jackknife
```{r jackknife}
sample_df = as.data.frame(y)
theta_hat_j = rep(0,n_obs)

for (i in 1:n_obs) {
  tmpData_df = sample_df[-i,]
  mu_hat_j = colMeans(tmpData_df)
  theta_hat_j[i] = mu_hat_j[1] / mu_hat_j[2]
}

#calculate the standard error of theta:
theta_hat_bar_j = mean(theta_hat_j)
se_theta_j = sqrt(((n_obs-1)/n_obs)*sum((theta_hat_j - theta_hat_bar_j)^2))

#95% CI of theta:
ci_low_j = theta_hat_bar_j - 1.96*se_theta_j
ci_high_j = theta_hat_bar_j + 1.96*se_theta_j
```
So the jackknife standard error for $\hat{\theta}$ is `r se_theta_j` and the 95% confidence interval for $\theta$ is [`r ci_low_j`,`r ci_high_j`].

<br>

### Question 4: Nonparametric Bootstrap
```{r nonparametric bootstrap}
B = 10000
theta_hat_b = rep(0,B)

for (i in 1:B) {
  idx = sample(n_obs, size=n_obs, replace=TRUE)
  tmpData_df = sample_df[idx,]
  mu_hat_b = colMeans(tmpData_df)
  theta_hat_b[i] = mu_hat_b[1] / mu_hat_b[2]
}

#calculate the standard error of theta:
se_theta_b = sd(theta_hat_b)

```

The bootstrap standard error for $\hat{\theta}$ is `r se_theta_b`.

<br>

Now, we use the \emph{boot} package to calculate regular, percentile, and BCA 95% confidence intervals:

```{r theta function}
theta_boot_fn = function(x, idx) {
  tmpData_df = x[idx,]
  mu_hat_b = colMeans(tmpData_df)
  theta_hat_b = mu_hat_b[1] / mu_hat_b[2]
  return(theta_hat_b)
}
```

```{r boot package bootstrap}
theta_boot = boot(sample_df,statistic=theta_boot_fn,R=10000)
boot.ci(theta_boot, conf=0.95, type=c("norm", "perc", "bca"))
```
<br>

### Question 5: Parametric Bootstrap

